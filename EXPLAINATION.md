# 项目说明

## 我完成的工作

1. **项目脚手架搭建**：根据实验三规格整理 FastAPI 后端结构，创建 `app/`、`models/`、`schemas/`、`routers/`、`services/` 等目录，并配置应用工厂、路由聚合、中间件和全局异常处理。
2. **数据库与模型**：集成 SQLAlchemy 2.0，提供 `Base` 元类、`SessionLocal` 以及事务辅助函数；实现用户、产品、交易、优惠券、会员、价格策略、审计日志等全部 ORM 模型。
3. **配置与安全**：编写 `.env` 支持的配置加载（含渠道解析与默认值校验），实现密码哈希、JWT 登录会话、双因素验证通道适配器与权限依赖。
4. **业务服务**：实现折扣引擎、风险管控、价格策略、搜索同义词扩展等核心服务，并在路由中调用这些服务封装业务逻辑。
5. **API 路由**：提供健康检查、认证、产品 CRUD、交易流程、促销/优惠券、会员、管理员配置、审计日志等一系列 REST 接口，覆盖实验需求。
6. **测试与工具**：补充 pytest 配置与夹具，使用内存 SQLite 驱动自动建表/拆表并覆盖健康检查、产品流程、折扣计算等测试；整理 `requirements.txt`、`pyproject.toml`、`.pylintrc`、VS Code 调试任务等工具链。
7. **缺陷修复与依赖调整**：清理自动生成的 markdown 符号导致的语法错误，补齐 Pydantic 引用，修正 SQLAlchemy 关联歧义，调整 bcrypt 版本与测试数据库线程配置以保证 pytest 全绿。

## 如何运行与使用

1. **准备环境**
	```bash
	cd backend
	python -m venv .venv
	source .venv/bin/activate
	pip install -r requirements.txt
	```
2. **配置环境变量**：在项目根目录创建 `.env`（可复制 `.env.example` 若已存在）并填写数据库、JWT、邮件等配置。测试模式可直接使用默认的 SQLite 内存库与示例密钥。
3. **初始化数据库**：
	```bash
	python -m scripts.create_tables
	```
	如需演示数据，可扩展 `scripts/` 目录下的种子脚本。
4. **启动服务**：
	```bash
	uvicorn app.main:create_app --reload --factory
	```
	服务默认监听 `http://127.0.0.1:8000`，`/docs` 暴露 Swagger 文档。
5. **运行测试**：
	```bash
	pytest
	```

## 当前支持的功能

- **健康检查**：`GET /health` 返回服务状态。
- **认证与安全**：登录发放 JWT，会话管理，双因素验证码流程，管理员与普通用户权限分离。
- **用户管理**：用户创建、信息查询、会话撤销、2FA 通道配置（路由已预留，可按需扩展）。
- **产品中心**：产品增删改查、标签多对多关联、状态流转、审计记录。
- **交易流程**：发起交易、校验优惠券、计算折扣与返现、状态确认、写入审计日志。
- **促销与优惠券**：优惠券创建、更新、列表、分配给指定用户，自动记录管理员操作。
- **会员与权益**：会员等级、权益方案、成长值规则及相关查询接口。
- **管理员配置**：参数版本化管理、价格策略（底价和补贴上限）、参数生效时间控制。
- **审计与风控**：记录关键操作日志，风险引擎对高风险订单做静态策略判定。
- **搜索扩展**：同义词配置及检索增强服务接口。
- **脚本工具**：数据库建表、后续可扩展数据填充/迁移脚本。

## 技术栈

- **后端框架**：FastAPI（基于 Starlette 与 Pydantic），提供异步/同步友好的 API 开发体验。
- **数据访问**：SQLAlchemy 2.0 Declarative + 会话管理，默认支持 SQLite，配置可指向 MySQL/PostgreSQL。
- **数据校验**：Pydantic v1，用于请求/响应模型与复杂字段验证。
- **安全组件**：Passlib（bcrypt）密码哈希、PyJWT 处理 access token、临时 2FA 传输适配器。
- **业务逻辑层**：自定义服务模块（折扣引擎、风险评分、价格策略、搜索同义词）。
- **测试框架**：Pytest + FastAPI TestClient，使用内存数据库与夹具隔离测试。
- **工具链**：Uvicorn 热重载、本地脚本、dotenv 配置、VS Code 调试配置、pytest-cov 覆盖率支持。
